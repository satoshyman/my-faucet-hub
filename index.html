<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TON Platinum 2026 - BeeClaimer</title>
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #050505; --card: #111; --primary: #0088CC; --secondary: #14F195; --gray: #a0a0a0; --line: #222; --glass: rgba(255, 255, 255, 0.05); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        [lang="ar"] { direction: rtl; text-align: right; }
        .lang-switch { position: fixed; top: 15px; right: 15px; background: var(--glass); border: 1px solid var(--line); color: #fff; padding: 5px 12px; border-radius: 10px; cursor: pointer; z-index: 1001; font-size: 0.8rem; }
        .ad-zone-top { width: 100%; height: 85px; display: flex; align-items: center; justify-content: center; padding: 10px; overflow: hidden; }
        .main-content { flex: 1; display: flex; align-items: center; justify-content: center; padding: 0 20px; position: relative; bottom: 15px; }
        .page-view { width: 100%; max-width: 420px; display: none; flex-direction: column; }
        .page-view.active { display: flex; animation: slideUp 0.4s ease-out; }
        .card { background: var(--card); border-radius: 35px; padding: 25px 20px; border: 1px solid var(--line); text-align: center; width: 100%; box-shadow: 0 25px 50px rgba(0,0,0,0.9); }
        .bal-val { font-size: 3rem; font-weight: 900; color: var(--primary); margin: 5px 0; font-family: 'Courier New', monospace; text-shadow: 0 0 15px rgba(0, 136, 204, 0.3); }
        .btn-main { width: 100%; padding: 18px; border-radius: 20px; border: none; background: var(--primary); color: #fff; font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: 0.3s; margin-top: 15px; }
        .btn-main:disabled { opacity: 0.2; filter: grayscale(1); }
        .v-input { width: 100%; padding: 16px; background: #000; border: 1px solid #333; color: #fff; border-radius: 20px; margin-bottom: 12px; text-align: center; font-size: 1rem; }
        .grid-info { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .info-item { background: var(--glass); padding: 12px; border-radius: 18px; border: 1px solid #222; }
        .info-label { display: block; font-size: 0.65rem; color: var(--gray); text-transform: uppercase; margin-bottom: 4px; }
        .info-value { display: block; font-size: 0.9rem; font-weight: bold; color: var(--primary); }
        .fpay-banner { background: linear-gradient(90deg, #1a1a1a, #000); border: 1px dashed var(--primary); border-radius: 20px; padding: 15px; margin-top: 15px; display: flex; align-items: center; justify-content: space-between; }
        .btn-reg { background: var(--primary); color: #fff; padding: 8px 14px; border-radius: 10px; text-decoration: none; font-size: 0.75rem; font-weight: bold; }
        .nav-bot { height: 95px; background: #000; display: flex; border-top: 1px solid var(--line); padding-bottom: 25px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--gray); cursor: pointer; font-size: 0.8rem; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.5rem; margin-bottom: 6px; }
        .smc-panel { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; padding: 25px; overflow-y: auto; }
        #p-bar { height: 8px; background: #222; border-radius: 10px; width: 80%; margin: 15px auto; overflow: hidden; }
        #p-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: 1s linear; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body lang="en">

<button class="lang-switch" onclick="toggleLang()">AR/EN</button>
<div class="ad-zone-top" id="ad-top-slot"></div>

<div class="main-content">
    <div id="p-home" class="page-view active">
        <div class="card">
            <img src="https://cryptologos.cc/logos/toncoin-ton-logo.png" style="width:60px;" id="smc-trigger">
            <div class="t-bal-label" style="color:var(--gray); font-size: 0.75rem; margin-top:10px;">AVAILABLE TON</div>
            <div id="bal-display" class="bal-val">0.000000</div>
            <div id="claim-area">
                <div style="display:flex; justify-content:center; margin:15px 0;"><div class="h-captcha" data-sitekey="50e831e4-919a-4c16-98ce-deaac51632a8" data-callback="onCap" data-theme="dark"></div></div>
                <button id="btn-claim" class="btn-main t-claim-btn" disabled onclick="doClaim()">CLAIM TON ⚡</button>
            </div>
            <div id="wait-area" class="hidden">
                <div id="timer-text" style="font-size:2.5rem; font-weight:900; color:var(--primary); margin:10px 0;">20:00</div>
                <div id="p-bar"><div id="p-bar-fill"></div></div>
                <p class="t-sync-text" style="color:var(--gray); font-size:0.8rem;">Next Claim in...</p>
            </div>
        </div>
    </div>

    <div id="p-wallet" class="page-view">
        <div class="card">
            <h3 class="t-withdraw-title" style="color:var(--primary)">WITHDRAW TON</h3>
            <div class="grid-info">
                <div class="info-item"><span class="info-label t-min-label">MINIMUM</span><span class="info-value" id="min-txt">0.1</span></div>
                <div class="info-item"><span class="info-label">NETWORK</span><span class="info-value" style="color:var(--secondary)">TON-FP</span></div>
            </div>
            <input type="text" id="w-email" placeholder="FaucetPay Email" class="v-input">
            <input type="number" id="w-amt" placeholder="Amount (TON)" class="v-input">
            <button class="btn-main t-withdraw-btn" onclick="doWithdraw()">WITHDRAW NOW</button>
            <div class="fpay-banner">
                <div style="text-align:left;"><div class="t-fpay-q" style="font-size:0.8rem; font-weight:bold;">No Wallet?</div><div class="t-fpay-a" style="font-size:0.65rem; color:var(--gray);">Get a FaucetPay account</div></div>
                <a href="https://faucetpay.io/?r=362774" target="_blank" class="btn-reg t-reg-btn">REGISTER</a>
            </div>
        </div>
    </div>

    <div id="p-refs" class="page-view">
        <div class="card">
            <h3 class="t-ref-title" style="color:var(--primary)">AFFILIATE PROGRAM</h3>
            <div class="grid-info">
                <div class="info-item"><span class="info-label t-comm-label">COMMISSION</span><span class="info-value">10%</span></div>
                <div class="info-item"><span class="info-label t-total-ref-label">TOTAL REFS</span><span class="info-value" id="ref-count">0</span></div>
            </div>
            <p style="font-size:0.75rem; color:var(--gray);" class="t-ref-desc">Share link & earn on every claim</p>
            <input type="text" id="ref-link" readonly class="v-input" style="font-size: 0.8rem; border:1px dashed var(--primary); background:rgba(0,136,204,0.05);">
            <button class="btn-main t-copy-btn" onclick="copyRef()">COPY LINK</button>
        </div>
    </div>
</div>

<div id="smc-ui" class="smc-panel">
    <h2 style="color:var(--primary)">ADMIN SETTINGS 2026</h2>
    <label>Ad HTML Code:</label><textarea id="cfg-ad" class="v-input" style="height:80px;"></textarea>
    <label>FaucetPay API Key:</label><input type="text" id="cfg-api" class="v-input">
    <label>TON Reward:</label><input type="number" id="cfg-reward" class="v-input" step="0.0001">
    <label>Wait (Min):</label><input type="number" id="cfg-wait" class="v-input" value="20">
    <label>Min Withdraw:</label><input type="number" id="cfg-min" class="v-input">
    <button class="btn-main" onclick="saveSMC()">SAVE SETTINGS</button>
    <button class="btn-main" onclick="document.getElementById('smc-ui').style.display='none'" style="background:#333;">EXIT</button>
</div>

<nav class="nav-bot">
    <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-gem"></i><span class="t-nav-faucet">Faucet</span></div>
    <div class="nav-item" onclick="nav('wallet', this)"><i class="fas fa-wallet"></i><span class="t-nav-wallet">Wallet</span></div>
    <div class="nav-item" onclick="nav('refs', this)"><i class="fas fa-users"></i><span class="t-nav-refs">Friends</span></div>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://ton-platinum-2026-default-rtdb.firebaseio.com/" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // بيانات تليجرام
    const tg = window.Telegram.WebApp;
    const tgId = tg.initDataUnsafe?.user?.id || "dev_user";
    const uid = "u_" + tgId;
    const startParam = tg.initDataUnsafe?.start_param; // لجلب معرف الداعي

    let sets = { reward: 0.001, wait: 20, min: 0.1, api: "", adCode: "" };
    let uBal = 0; let tTick; let currentLang = 'en';

    const userRef = ref(db, 'users/' + uid);
    const configRef = ref(db, 'config');

    const trans = {
        en: { balLabel: "AVAILABLE TON", claimBtn: "CLAIM TON ⚡", sync: "Next Claim in...", withTitle: "WITHDRAW TON", minLab: "MINIMUM", withBtn: "WITHDRAW NOW", fpayQ: "No Wallet?", fpayA: "Get a FaucetPay account", reg: "REGISTER", refTitle: "AFFILIATE PROGRAM", comm: "COMMISSION", tRef: "TOTAL REFS", refDesc: "Share link & earn on every claim", copy: "COPY LINK", navF: "Faucet", navW: "Wallet", navR: "Friends" },
        ar: { balLabel: "رصيد تون المتاح", claimBtn: "مطالبة TON ⚡", sync: "المطالبة التالية خلال...", withTitle: "سحب العملات", minLab: "الحد الأدنى", withBtn: "اسحب الآن", fpayQ: "ليس لديك محفظة؟", fpayA: "سجل في فوست باي الآن", reg: "تسجيل", refTitle: "برنامج الإحالة", comm: "العمولة", tRef: "إجمالي الإحالات", refDesc: "شارك الرابط واربح مع كل مطالبة", copy: "نسخ الرابط", navF: "الصنبور", navW: "المحفظة", navR: "الأصدقاء" }
    };

    window.toggleLang = () => {
        currentLang = currentLang === 'en' ? 'ar' : 'en';
        document.body.lang = currentLang;
        const T = trans[currentLang];
        document.querySelector('.t-bal-label').innerText = T.balLabel;
        document.querySelector('.t-claim-btn').innerText = T.claimBtn;
        document.querySelector('.t-sync-text').innerText = T.sync;
        document.querySelector('.t-withdraw-title').innerText = T.withTitle;
        document.querySelector('.t-min-label').innerText = T.minLab;
        document.querySelector('.t-withdraw-btn').innerText = T.withBtn;
        document.querySelector('.t-fpay-q').innerText = T.fpayQ;
        document.querySelector('.t-fpay-a').innerText = T.fpayA;
        document.querySelector('.t-reg-btn').innerText = T.reg;
        document.querySelector('.t-ref-title').innerText = T.refTitle;
        document.querySelector('.t-comm-label').innerText = T.comm;
        document.querySelector('.t-total-ref-label').innerText = T.tRef;
        document.querySelector('.t-ref-desc').innerText = T.refDesc;
        document.querySelector('.t-copy-btn').innerText = T.copy;
        document.querySelector('.t-nav-faucet').innerText = T.navF;
        document.querySelector('.t-nav-wallet').innerText = T.navW;
        document.querySelector('.t-nav-refs').innerText = T.navR;
    };

    // نظام فحص وتسجيل الإحالات
    async function checkReferral() {
        const snapshot = await get(userRef);
        if (!snapshot.exists() && startParam && startParam != tgId) {
            const inviterRef = ref(db, 'users/u_' + startParam);
            const inviterSnap = await get(inviterRef);
            if (inviterSnap.exists()) {
                const currentRefCount = inviterSnap.val().refCount || 0;
                await update(inviterRef, { refCount: currentRefCount + 1 });
            }
        }
    }

    onValue(configRef, (s) => { 
        if(s.exists()) { 
            sets = s.val(); 
            document.getElementById('min-txt').innerText = sets.min;
            document.getElementById('cfg-ad').value = sets.adCode || "";
            document.getElementById('cfg-api').value = sets.api || "";
            document.getElementById('cfg-reward').value = sets.reward || 0.001;
            document.getElementById('cfg-wait').value = sets.wait || 20;
            document.getElementById('cfg-min').value = sets.min || 0.1;
            if(sets.adCode) document.getElementById('ad-top-slot').innerHTML = sets.adCode;
        } 
    });

    onValue(userRef, async (s) => {
        if(!s.exists()) {
            await set(userRef, { balance: 0, last: 0, refCount: 0 });
            checkReferral(); // فحص الإحالة للمستخدم الجديد
        } else {
            const d = s.val(); uBal = d.balance || 0;
            document.getElementById('bal-display').innerText = uBal.toFixed(6);
            document.getElementById('ref-count').innerText = d.refCount || 0;
            // استخدام رابط startapp الصحيح مع BeeClaimer_bot
            document.getElementById('ref-link').value = `https://t.me/BeeClaimer_bot?startapp=${tgId}`;
            runTimer(d.last || 0);
        }
    });

    function runTimer(last) {
        clearInterval(tTick);
        const waitMs = Number(sets.wait) * 60000;
        const tick = () => {
            const diff = waitMs - (Date.now() - last);
            if(last > 0 && diff > 0) {
                document.getElementById('claim-area').classList.add('hidden');
                document.getElementById('wait-area').classList.remove('hidden');
                const m = Math.floor(diff/60000); const s = Math.floor((diff%60000)/1000);
                document.getElementById('timer-text').innerText = `${m}:${s<10?'0'+s:s}`;
                document.getElementById('p-bar-fill').style.width = ((waitMs-diff)/waitMs*100) + "%";
            } else {
                document.getElementById('wait-area').classList.add('hidden');
                document.getElementById('claim-area').classList.remove('hidden');
                clearInterval(tTick);
            }
        };
        tick(); tTick = setInterval(tick, 1000);
    }

    window.onCap = () => { document.getElementById('btn-claim').disabled = false; };

    window.doClaim = async () => {
        const btn = document.getElementById('btn-claim');
        btn.disabled = true;
        const snapshot = await get(userRef);
        const userData = snapshot.val();
        const lastClaim = userData.last || 0;
        const waitMs = Number(sets.wait) * 60000;
        const now = Date.now();

        if (lastClaim > 0 && (now - lastClaim) < waitMs) {
            Swal.fire({ title: currentLang === 'en'?'Security Check':'تحقق الأمان', text: currentLang === 'en'?'Wait for timer!':'انتظر انتهاء الوقت!', icon: 'warning' });
            runTimer(lastClaim);
            return;
        }

        try {
            await update(userRef, { balance: uBal + parseFloat(sets.reward), last: now });
            hcaptcha.reset();
            Swal.fire({ title: currentLang === 'en'?'TON Claimed!':'تمت المطالبة!', icon: 'success', timer: 1500, showConfirmButton: false });
            runTimer(now);
        } catch(e) { btn.disabled = false; }
    };

    window.doWithdraw = async () => {
        const email = document.getElementById('w-email').value;
        const amt = parseFloat(document.getElementById('w-amt').value);
        if(!email || isNaN(amt) || amt < sets.min || amt > uBal) return Swal.fire('Error', 'Invalid data', 'error');
        Swal.fire({ title: 'Processing...', didOpen: () => { Swal.showLoading(); } });
        try {
            const res = await fetch('https://faucetpay.io/api/v1/send', { method: 'POST', body: new URLSearchParams({ api_key: sets.api, currency: 'TON', amount: (amt*100000000).toFixed(0), to: email }) });
            const r = await res.json();
            if(r.status === 200) { await update(userRef, { balance: uBal - amt }); Swal.fire('Success!', 'Sent to FaucetPay', 'success'); }
            else Swal.fire('Error', r.message, 'error');
        } catch(e) { Swal.fire('Error', 'API Error', 'error'); }
    };

    window.nav = (p, el) => {
        document.querySelectorAll('.page-view').forEach(v => v.classList.remove('active'));
        document.getElementById('p-'+p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    };

    window.copyRef = () => {
        const el = document.getElementById('ref-link'); el.select(); document.execCommand('copy');
        Swal.fire({ title: currentLang==='en'?'Copied!':'تم النسخ', icon:'success', timer:1000, showConfirmButton: false });
    };

    window.saveSMC = async () => {
        await update(configRef, { adCode: document.getElementById('cfg-ad').value, api: document.getElementById('cfg-api').value, reward: parseFloat(document.getElementById('cfg-reward').value), wait: parseInt(document.getElementById('cfg-wait').value), min: parseFloat(document.getElementById('cfg-min').value) });
        Swal.fire('Saved!', '', 'success');
    };

    let g = 0;
    document.getElementById('smc-trigger').onclick = () => { 
        g++; if(g>=5) { 
            Swal.fire({ title: 'Admin', input: 'password' }).then((r) => { if (r.value === "Ahmednnn3") document.getElementById('smc-ui').style.display='block'; g=0; });
        }
    };
    tg.expand();
</script>
</body>
</html>
